
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Nikhil Mungel</title>

  <!-- SSH uses four TCP segments for each character you type - My Musings -->
  <meta name="author" content="Nikhil Mungel">

  
  <meta name="description" content="Everytime we press a key in an interactive SSH session, the SSH Client
sends that keystroke as a TCP segment to the SSH Server. Here is a
Wireshark &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.hyfather.com/blog/2013/04/18/ssh-uses-four-tcp-segments-for-each-character/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="My Musings" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32384931-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Musings</a></h1>
  
    <h2>on programming, systems and learning.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.hyfather.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Blog Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">SSH uses four TCP segments for each character you type</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-18T23:38:00-07:00" pubdate data-updated="true">Apr 18<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Everytime we press a key in an <em>interactive</em> SSH session, the SSH Client
sends that keystroke as a TCP segment to the SSH Server. Here is a
Wireshark capture of I having SSH-ed into my own machine and pressing
a <em>single key</em>. I have not included packets indicating the setup and
teardown of the TCP and SSH connections.</p>

<p><img src="/images/ssh4packets.png">
<em>You can differentiate between the client and server from the
source and destination port numbers. SSH servers usually work on port 22.</em></p>

<p>After the client has transmitted a character over a TCP segment, the
server acknowledges that it has received it. Acknowledgements of data
enable TCP to provide a reliable transport service to higher level
protocols like HTTP, SMTP and SSH.</p>

<p>After this, the server actually processs the character by sending it
to the program, which is typically <code>bash</code>, but could be anything &#8211;
<code>sh</code>, <code>zsh</code> or even <code>emacs</code>. The shell will interpret the character
and send back the result over another TCP segment. This enables the
client to <em>echo</em> the character on the screen and send back an
acknowledgement to the server.</p>

<p>I have depicted this in a timeline &#8211;</p>

<p><img src="/images/sshtimeline.png" title="" ></p>

<h2>I tried this out and I can see only three segments per character I type</h2>

<p>To be minimal about the traffic that sending acknowledgements for data
causes, TCP piggybacks ACKs on data that it has to send anyway. This
is implementation specific, though if you were using the socket API,
you&#8217;d set the TCP_QUICKACK option to disable delayed acknowlegments.</p>

<p>Here is an example of this happening when I SSH-ed into an AWS EC2
server.</p>

<p><img src="/images/ssh3packets.png">
<em>Note that the server is sending the ACK to the character it received
and the response together in one TCP segment.</em></p>

<h2>Why not send whole commands?</h2>

<p>One may wonder why does SSH not transmit every command or every line
rather than sending individual characters. The
answer lies in the fact that the program on the server may
have commands that are only a character long, without requiring a
newline character. Think ESC in
<code>vi</code>, or M-x in <code>emacs</code>, or SPACE in <code>more</code>. Even while sending
commands to <code>bash</code>, there could be readline-specific keystrokes like
C-e or C-a or even TAB that need to be sent as they are pressed
instead of waiting for a newline.
So, SSH chooses not to try to understand what sequence of characters
constitute a command and simply sends across characters as they are
typed. In fact, it doesn&#8217;t even assume if and how the character
pressed will echo on the screen, it finds it out from the server program.</p>

<h2>What happens when I use SSH with other software like git?</h2>

<p>One the most frequent ways that I use SSH is when I do any remote
<code>git</code> operations like <code>pull</code>, <code>push</code>, or <code>clone</code>. When actual data is
being sent, the SSH software understands that it isn&#8217;t an interactive
invocation and TCP utilizes all the available capacity of a each
segment to help SSH send all that data.</p>

<p>Deciding the sizes of segments is left to TCP and would warrant a blog
post by itself, but here is a quick primer &#8211; The Maximum Segment Size (MSS) that TCP calculates
is such that there will be no IP layer fragmentation of segments. In
other words, TCP sets its MSS lesser than or equal to the Path MTU (Maximum
Transmission Unit). TCP also sets the Don&#8217;t Fragment (DF) Flag to
ensure that Segments don&#8217;t get fragmented on the IP.</p>

<p>Here is a capture of Wireshark sniffing data when I cloned a
repository from GitHub over SSH.</p>

<p><img src="/images/sshbulkdata.png">
<em>Note how the data in each segement plus the TCP and IP headers equal
the exact MTU of my Ethernet interface &#8211; 1500</em></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Nikhil Mungel</span></span>

      








  


<time datetime="2013-04-18T23:38:00-07:00" pubdate data-updated="true">Apr 18<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.hyfather.com/blog/2013/04/18/ssh-uses-four-tcp-segments-for-each-character/" data-via="hyfather" data-counturl="http://blog.hyfather.com/blog/2013/04/18/ssh-uses-four-tcp-segments-for-each-character/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/03/04/ifconfig/" title="Previous Post: The Missing Man Page for ifconfig">&laquo; The Missing Man Page for ifconfig</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/18/ssh-uses-four-tcp-segments-for-each-character/">SSH uses four TCP segments for each character you type</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/04/ifconfig/">The Missing Man Page for ifconfig</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/20/crafting-beautiful-command-line-applications-with-ruby/">Crafting Beautiful Command Line Applications with Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/17/restricted-bash/">Restricted Bash</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/18/bundler/">Bundler and RVM</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("hyfather", 2, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/hyfather" class="twitter-follow-button" data-show-count="true">Follow @hyfather</a>
  
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/hyfather">@hyfather</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'hyfather',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Nikhil Mungel -
  <span class="credit">Powered
    by <a href="http://octopress.org" target="_blank">Octopress</a> and hosted
    on <a href="https://help.github.com/categories/20/articles" target="_blank">GitHub Pages</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hyfather';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.hyfather.com/blog/2013/04/18/ssh-uses-four-tcp-segments-for-each-character/';
        var disqus_url = 'http://blog.hyfather.com/blog/2013/04/18/ssh-uses-four-tcp-segments-for-each-character/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
